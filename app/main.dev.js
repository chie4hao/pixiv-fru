/* eslint global-require: 1, flowtype-errors/show-errors: 0 */

/**
 * This module executes inside of electron's main process. You can start
 * electron renderer process from here and communicate with the other processes
 * through IPC.
 *
 * When running `npm run build` or `npm run build-main`, this file is compiled to
 * `./app/main.prod.js` using webpack. This gives us some performance wins.
 *
 * @flow
 */
import { app, BrowserWindow, nativeImage } from 'electron';
import path from 'path';
import MenuBuilder from './menu';

const image = nativeImage.createFromDataURL('data:image/png;base64,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');

let mainWindow = null;

if (process.env.NODE_ENV === 'production') {
  const sourceMapSupport = require('source-map-support');
  sourceMapSupport.install();
}

if (process.env.NODE_ENV === 'development' || process.env.DEBUG_PROD === 'true') {
  require('electron-debug')();
  const p = path.join(__dirname, '..', 'app', 'node_modules');
  require('module').globalPaths.push(p);
}

const installExtensions = async () => {
  const installer = require('electron-devtools-installer');
  const forceDownload = !!process.env.UPGRADE_EXTENSIONS;
  const extensions = [
    'REACT_DEVELOPER_TOOLS',
    'REDUX_DEVTOOLS'
  ];

  return Promise
    .all(extensions.map(name => installer.default(installer[name], forceDownload)))
    .catch(console.log);
};


/**
 * Add event listeners...
 */

app.on('window-all-closed', () => {
  // Respect the OSX convention of having the application in memory even
  // after all windows have been closed
  if (process.platform !== 'darwin') {
    app.quit();
  }
});


app.on('ready', async () => {
  if (process.env.NODE_ENV === 'development' || process.env.DEBUG_PROD === 'true') {
    await installExtensions();
  }

  mainWindow = new BrowserWindow({
    show: false,
    width: 1024,
    height: 728,
    icon: image
  });

  mainWindow.setMenu(null);

  mainWindow.loadURL(`file://${__dirname}/app.html`);

  // @TODO: Use 'ready-to-show' event
  //        https://github.com/electron/electron/blob/master/docs/api/browser-window.md#using-ready-to-show-event
  mainWindow.webContents.on('did-finish-load', () => {
    if (!mainWindow) {
      throw new Error('"mainWindow" is not defined');
    }
    mainWindow.show();
    mainWindow.focus();
  });

  mainWindow.on('closed', () => {
    mainWindow = null;
  });

  const menuBuilder = new MenuBuilder(mainWindow);
  menuBuilder.buildMenu();
});
